@{
    ViewData["Title"] = "Оплата";
}

<div class="container my-5">
    <h2 class="text-center mb-4">Оплата заказа</h2>

    <div class="text-center mb-4">
        <h4>Сумма к оплате: <span id="paymentTotal">0.00</span> руб.</h4>
    </div>

    <div class="text-center mb-3">
        <label for="coinInput" class="form-label">Вставьте монеты (введите сумму):</label>
        <input type="number" class="form-control d-inline-block w-auto" id="coinInput" step="0.01" min="0">
    </div>

    <div class="text-center">
        <button id="payBtn" class="btn btn-success">Оплатить</button>
    </div>
</div>

@section Scripts {
        <script>
            const selectedDrinks = JSON.parse(localStorage.getItem("selectedDrinks")) || [];

            function calculateTotal(drinks) {
                return drinks.reduce((sum, item) => sum + parseFloat(item.price), 0).toFixed(2);
            }

            document.getElementById("paymentTotal").textContent = calculateTotal(selectedDrinks);

            document.getElementById("payBtn").addEventListener("click", function () {
                const coinInput = document.getElementById("coinInput");
                const inserted = parseFloat(coinInput.value);
                const total = parseFloat(document.getElementById("paymentTotal").textContent);

                if (isNaN(inserted) || inserted < total) {
                    alert("Внесённой суммы недостаточно!");
                    return;
                }

                fetch("/Order/SaveOrder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        items: selectedDrinks.map(d => ({ id: d.id, price: parseFloat(d.price) })),
                        totalPrice: total,
                        totalInserted: inserted
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem("selectedDrinks");
                        alert(`Заказ оплачен! Сдача: ${data.change.toFixed(2)} руб.`);
                        window.location.href = "/Order/Success";
                    } else {
                        alert("Ошибка при сохранении заказа.");
                    }
                })
                .catch(err => {
                    alert("Ошибка соединения с сервером.");
                    console.error(err);
                });
            });
        </script>
}
